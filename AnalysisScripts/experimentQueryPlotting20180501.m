% exptList={'multichambers201608{2}', 'multichambers201608{3}',...
% 'multichambers201608{4}',...
% 'multichambers201608{5}',...
% 'multichambers201608{6}',...
% 'multichambers201608{7}',...
% 'multichambers201608{8}',...
% 'multichambers20161014{1}',...
% 'multichambers20161014{2}',...
% 'multichambers20161015{1}',...
% 'multichambers20161015{2}',...
% 'multichambers20161016{1}',...
% 'multichambers20161016{2}',...
% 'multichambers20161025{1}',...
% 'multichambers20161025{2}',...
% 'multichambers20161110{1}',...
% 'multichambers20161115{1}',...
% 'multichambers20161115{2}',...
% 'multichambers20161116{1}',...
% 'multichambers20161116{2}',...
% 'multichambers20161116{3}',...
% 'multichambers20161116{3}',...
% 'multichambers20161130{1}',...
% 'multichambers20161130{2}',...
% 'multichambers20161130{3}',...
% 'multichambers20161130{4}',...
% 'multichambers20161204{1}',...
% 'multichambers20161204{2}',...
% 'multichambers20161204{3}',...
% 'multichambers20161206{1}',...
% 'multichambers20161206{2}',...
% 'multichambers20161207{1}',...
% 'multichambers20161207{2}',...
% }'
% 
% containsStrain = @(expmt,str) sum(strcmp(fieldnames(evalin( 'base', expmt)), str))>0;
% sCon=cellfun(containsStrain, repmat(exptList, numel(strains), 1), repmat(strains', 1, numel(exptList)))
% strains={'hxt4', 'mig1gfp'}


concentrations=[
0.4,...%20170610  glucose 0.4 hat
0.4,...%20170613 glucose 0.4 hat
0.2,...%20170615 glucose 0.2% hat %0.4,...%20170627 glucose 0.4% hat.FAULTY EXPT
0.4,...%20170629 glucose 0.4 hat
0.4,...%20170630 glucose 0.4 hat
1,...%20170703 glucose 1% hat
1, ...%20170704 1% hat
0.2, ...%20170720 0.2% hat
0.2,...%20170721 0.2% hat
0.2,...%20170722 0.2% hat
1,...%20170518 1% hat
1,...%20170525 1% hat
1,...%20170521 1% hat
]

exptList={...
    'multichamber20170610',...
    'multichamber20170613',...
    'multichamber20170615',...
    'multichamber20170629',...
    'multichamber20170630',...
    'multichamber20170703',...
    'multichamber20170704',...
    'multichamber20170720',...
    'multichamber20170721',...
    'multichamber20170722'...
    'multichamber20170518'...
    'multichamber20170525'...
    'multichamber20170521'...
    }
    
%     'multichamber20171009'...
%     'multichamber20171012'...
%     'multichamber20171013'...
%     'multichamber20171013'...
%     'multichamber20170704'...
%     'multichamber20171221'...
%     'multichamber20171229'...
%     'multichamber20171229'...
%     
%     
% }

%tb=table(exptList(:), concentrations(:), 'VariableNames',{'Experiment', 'Concentration'} )


%% 
mode=2; 

strains={...
    'hxt4';...
    'mig1ko';...
    'snf3';...
    'rgt2';...
    'std1';...
    'mth1';...
    'wt';...
    'phxt4';...
    'yck1';...
    'yck2'}


cmap=[0,0,0;0,.5, .5;0,.8,.8];
plotcons=[0.2, 0.4, 1]

  figure;
  
for q=1:numel(strains)
  
for j=1:numel(plotcons)
   subplot(numel(strains), numel(plotcons), numel(plotcons)*(q-1)+j)
   try 
   if mode==1
%this mode matches the exact strain
containsStrain = @(expmt,str) sum(strcmp(fieldnames(evalin( 'base', expmt)), str))>0;
sCon=cell2mat(cellfun(containsStrain, repmat(exptList, numel(strains(q)), 1), repmat(strains(q)', 1, numel(exptList)), 'UniformOutput', false))
else
    if mode ==2
%this one matches anything that contains the specified substring. WARNING:
%can pick up a lot of weird stuff
containsStrain = @(expmt,str) sum(cell2mat(strfind(fieldnames(evalin( 'base', expmt)), str)))>0;
sCon=cell2mat(cellfun(containsStrain, repmat(exptList, numel(strains(q)), 1), repmat(strains(q)', 1, numel(exptList)), 'UniformOutput', false))
    end
end
   refmin=0; %adjust accordingly to normalise
   refmax=1; %adjust accordingly to normalise 
 exptchoice=exptList(sCon)  
   localcons= concentrations(sCon); %concs of the experiments chosen
   whicharequery= localcons==plotcons(j); %which expts belong to the concentration in place
   conlist=exptchoice(whicharequery)
   if ~isempty(conlist)
   
   
    for k=1:numel(conlist)
        cExperiment=evalin('base', conlist{k});
        if mode==1
            strn=strains(q);
        else
        if mode==2
            nms=fieldnames(cExperiment);
            strn= nms{logical(cellfun(@empty2Zero, strfind(nms, strains(q))))}%we only do 1 strain name
            %suppose there are more than one. choose one and display a
            %warning
            if iscell(strn) && numel(strn)>1
            disp(['WARNING: more than one strain in experiment ' conlist{k} ' contains string' strains{q} '. using the first one']);
            strn=strn{1};
            end
        end
        end
        
        cExperiment=cExperiment.(strn)
        range=1:size(cExperiment.cellInf(2).mean,2);
        try
        times=mean(cExperiment.cellInf(1).times(:, range))/60;
    catch
        times=(range-1)*5/60;
        end

         mn=(nonzeroColMean(cExperiment.cellInf(2).mean(:,range))-refmin)/refmax;
        boundedline(times, mn, prepareBound((cExperiment.cellInf(2).mean(:,range)-refmin)/refmax, @nonZeroColSEM), 'cmap', cmap(j,:))
        hold on;
        xlabel('Time (Hrs)')
        ylabel('Mean cell FL (±SEM)')
        title([strains{q} 'in' num2str(plotcons(j))])
    end
   end

   end
end
end


uniformAxes(gcf, [], [], [800, 3000],[], [] )



